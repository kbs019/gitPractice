<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ex.gitprac.repository.rec.RecMapper">

  <insert id="insertRec" parameterType="com.ex.gitprac.data.rec.RecDTO">
    <selectKey keyProperty="recNo" resultType="int" order="BEFORE">
      SELECT rec_seq.NEXTVAL FROM dual
    </selectKey>
    INSERT INTO rec (
      rec_no, writer, pet_no, category, title, content, reg
    ) VALUES (
      #{recNo}, #{writer}, #{petNo}, #{category}, #{title}, #{content}, SYSDATE
    )
  </insert>

  <select id="findAll" resultType="com.ex.gitprac.data.rec.RecDTO">
    SELECT
      rec_no AS recNo,
      writer,
      pet_no AS petNo,
      category,
      title,
      content,
      reg
    FROM rec
    ORDER BY reg DESC
  </select>

  <select id="findFiltered" resultType="com.ex.gitprac.data.rec.RecDTO">
    SELECT
     rec_no AS recNo,
     writer,
     pet_no AS petNo,
     category,
     title,
     content,
     reg
   FROM rec
   <where>
     <if test="petNo != null">
        pet_no = #{petNo}
      </if>
     <if test="startDate != null and endDate != null">
       AND reg BETWEEN TO_DATE(#{startDate}, 'YYYY-MM-DD') AND TO_DATE(#{endDate}, 'YYYY-MM-DD')
     </if>
     <if test="categoryGroup != null">
       AND (
         <choose>
           <when test="categoryGroup eq '밥/간식'">
             category IN ('밥', '간식')
           </when>
           <when test="categoryGroup eq '배변/배뇨'">
             category IN ('배변', '배뇨')
           </when>
           <when test="categoryGroup eq '병원/약'">
             category IN ('병원', '약')
           </when>
           <otherwise>
             category = #{categoryGroup}
           </otherwise>
         </choose>
       )
     </if>
   </where> 
   ORDER BY reg DESC
  </select>

</mapper>
