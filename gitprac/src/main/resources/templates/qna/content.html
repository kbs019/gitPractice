<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="/css/qnaContent.css">
    <link rel="stylesheet" href="/css/qnaReplyList.css">
    <link rel="stylesheet" href="/css/header.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR&display=swap" rel="stylesheet">
</head>
<body>
    <div th:replace="~{fragments/header.html :: headerFragment}"></div>
    <div class="content-top">
        <div class="content-top-title">
            <center>ê¸€ ë‚´ìš©</center>
            <hr width="600" align="center" color="orange">
        </div>
        <div class="content-top-btns">
            <div width="600" align="right">
                <span th:if="${ session.users.nick == qto.writer }">
                    <input type="button" value="ìˆ˜ì •" th:onclick="|window.location='@{/qna/update(postNo=${qto.postNo}, pageNum=${pageNum})}'|">  &nbsp;&nbsp;
                </span>
                <span th:if="${session.users.nick == qto.writer || session.users.role == 2}">
                    <input type="button" value="ì‚­ì œ" th:onclick="|window.location='@{/qna/delete(postNo=${qto.postNo}, pageNum=${pageNum})}'|">  &nbsp;&nbsp;
                </span>
            </div>
        </div>
    </div>
    <div class="content-body">
        <div class="content-title-wrapper">
            <h3><span th:text="${qto.title}"></span></h3>
        </div>
        <div class="content-info-wrapper">
            <div class="content-writer-wrapper">
                ì‘ì„±ì | <span th:text="${qto.writer}"></span>
                <span th:if="${session.users.role == 2}" class="copy-icon" th:attr="data-writer=${qto.writer}">
                    ğŸ“‹
                </span>
            </div>
            <div class="content-views-wrapper">
                ì¡°íšŒìˆ˜ | <span th:text="${qto.views}"></span>
            </div>
            <div class="content-reg-wrapper">
                ì‘ì„±ì¼ì | <span th:text="${#temporals.format(qto.reg, 'yy/MM/dd HH:mm')}"></span>
            </div>
        </div>    
        <div class="content-image-wrapper" th:if="${qto.originalName != null}">
            <img th:src="@{|${qto.imgPath + qto.imgName}|}">    
        </div>
        <div class="content-content-wrapper">
            <div th:text="${qto.content}"></div>
        </div>
        <div class="content-btn-wrapper" th:if="${qto.showRecord == 1}">    <!-- ì´ ë¶€ë¶„ ì´ë ‡ê²Œ í•œë²ˆì— ì§„í–‰ì´ ë ê¹Œ? -->
            <span th:if="${session.users.role == 1}">
                <button onclick="showRecord()">ì¼ì§€ ë³´ê¸°</button>
            </span>
        </div>
    </div>

    <div class="content-bottom-btns">
        <input type="button" value="ê¸€ëª©ë¡" th:onclick="|window.location='@{/qna/list(pageNum=${pageNum})}'|">
    </div>

    <div class="reply-block">
        <div class="reply-insert-form" th:if="${session.users.role == 1}">      <!-- ìˆ˜ì˜ì‚¬ë§Œ ëŒ“ê¸€ ì…ë ¥í¼ì´ ë³´ì´ë„ë¡ ì„¤ì • -->
            <form id="replyInsertForm">
                <input type="hidden" id="postNo" th:value="${qto.postNo}">
                <input type="hidden" id="writer" th:value="${session.users.nick}">
                <textarea id="replyContent" required></textarea>
                <button type="button" id="replyInsertBtn">ë‹µë³€ ì‘ì„±</button>
            </form>
        </div>
        <input type="hidden" id="postNo" th:value="${qto.postNo}">
        <div id="replyList"></div>  <!-- ì—¬ê¸°ì— ë¦¬ìŠ¤íŠ¸ ì¶œë ¥ì‹œí‚¬ ì˜ˆì • -->
    </div>
    
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <!-- ì¼ì§€ ë³´ê¸° ë²„íŠ¼ í´ë¦­ ì‹œ, íŒì—…ì°½ open -->
    <script th:inline="javascript">
        function showRecord() {
            let writer = /*[[${qto.writer}]]*/ 'anonymous'; // ì‘ì„±ì ë‹‰ë„¤ì„ ë“± ë„˜ê¸¸ ê°’

            window.open(
                '/qna/showRecord?nick=' + encodeURIComponent(writer),
                'popupRecord',
                'width=800,height=700'
            );
        }
    </script>

    <!-- ë‹µë³€ ì‘ì„± í´ë¦­ ì‹œ, ajax ì‹¤í–‰ -->
    <script>
        $(document).ready(function(){
            $('#replyInsertBtn').click(function(){
                $.ajax({
                    url : '/qna/replyInsert',
                    type : 'post',
                    data : {
                        postNo : $('#postNo').val(),
                        writer : $('#writer').val(),
                        content : $('#replyContent').val()
                    },
                    success : function( result ){
                        alert(result);
                        $('#replyContent').val('');
                        loadReplies();
                    },
                    error : function( xhr, status, error ){
                        console.log(error + '  ë°œìƒ');
                        alert('ì˜¤ë¥˜ ë°œìƒ');
                    }
                });
            });
        });

        // ë‹µë³€ ë¦¬ìŠ¤íŠ¸ë¥¼ ë³´ì—¬ì£¼ëŠ” ì‘ì—…
        $(document).ready(function(){
            loadReplies();
        });

        // ë‹µë ¨ ë¦¬ìŠ¤íŠ¸ ë¡œë”© ì‹œí‚¤ëŠ” í•¨ìˆ˜
        function loadReplies(){
            $.ajax({
                url : '/qna/replyList',
                type : 'post',
                data : {
                    postNo : $('#postNo').val()
                },
                success : function( replyTable ){
                    $('#replyList').html(replyTable);
                },
                error : function( xhr, status, error ){
                    console.log(error + "-- ë°œìƒ");
                    alert("ì˜¤ë¥˜ ë°œìƒ");
                }
            });
        }
        

        // ë‹µë³€ ì‚­ì œ ë²„íŠ¼ í´ë¦­ ì‹œ ì§„í–‰ë˜ëŠ” ajax
        $(document).ready(function(){           // html ë¬¸ì„œê°€ ëª¨ë‘ ë¡œë”©ëœ í›„ ì‹¤í–‰ë˜ëŠ” í•¨ìˆ˜
            $(document).on('click', '.replyDelete', function(){
            // .replyDelete í´ë˜ìŠ¤ë¥¼ ê°€ì§„ ë²„íŠ¼ì´ í´ë¦­ë˜ì—ˆì„ ë•Œ ì‹¤í–‰.
            // on() : ë™ì ìœ¼ë¡œ ìƒì„±ëœ ìš”ì†Œì—ë„ ì ìš©ë˜ë„ë¡ ë„ì™€ì¤€ë‹¤.  
            // --> ë‹µë³€ì‘ì„±ì´ë¼ëŠ” ajax ë¡œ ìƒì„±ë˜ì–´ ajax ë¡œ ë¦¬ìŠ¤íŠ¸ê°€ ì¶œë ¥ëœ .replyDelete ë¼ëŠ” í´ë˜ìŠ¤ëª…ì˜ ë²„íŠ¼ì— click ì´ë²¤íŠ¸ë¥¼ ë„£ì–´ í•¨ìˆ˜ ì‹¤í–‰

                let replyNo = $(this).closest('.reply-item').find('.replyNo').val();
                // í´ë¦­ëœ '.replyDelete' ë²„íŠ¼('this')ì„ ê¸°ì¤€ìœ¼ë¡œ
                // ê°€ì¥ ê°€ê¹Œìš´ ìƒìœ„ ìš”ì†Œ ì¤‘ '.reply-item' ë¼ëŠ” í´ë˜ìŠ¤ ì„ íƒì ì´ë¦„ì„ ê°€ì§„ ìš”ì†Œë¥¼ ì°¾ê³ 
                // ê·¸ ë‚´ë¶€ì—ì„œ '.replyNo' í´ë˜ìŠ¤ë¥¼ ê°€ì§„ input ì˜ ê°’ì„ ê°€ì ¸ì˜¨ë‹¤.

                $.ajax({            // ajax ìš”ì²­ ì‹œì‘
                    url : '/qna/replyDelete2',
                    type : 'post',
                    data : {
                        replyNo : replyNo
                    },
                    success : function(a){
                        alert(a);
                        loadReplies();
                    },
                    error : function( xhr, status, error ){
                        console.log('ì˜¤ë¥˜ : ' + error);
                        alert('ì˜¤ë¥˜ ë°œìƒ!');
                    }
                });
            });
        });

        // ì‘ì„±ìëª…ì„ í´ë¦­í•˜ì—¬ ë³µì‚¬í•˜ëŠ” API ì‚¬ìš©
        $(document).ready(function(){
            $(document).on('click', '.copy-icon', function(e){
                let writer = $(this).data('writer');
    
                navigator.clipboard.writeText(writer).then(function(){
                    alert(`"${writer}" ë³µì‚¬ë¨`);
                }).catch(function(err){
                    console.log("ë³µì‚¬ ì‹¤íŒ¨ : ", err);
                });
            });
        });
    </script>
</body>
</html>