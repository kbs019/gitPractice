<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>MyPage</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/rec.css">
    <link rel="stylesheet" href="/css/header.css">
</head>
<body>    
    <div th:replace="~{fragments/header.html :: headerFragment}"></div>
    <center><h1>ë§ˆì´í˜ì´ì§€</h1></center>

    <!-- ë‚´ ì •ë³´ ì˜ì—­ -->
    <div id="myInfoSection">
        <h2>ë‚´ ì •ë³´</h2>
        <div id="myInfoView">
            <!-- ì‚¬ìš©ì ì •ë³´ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
        </div>

        <button onclick="showUpdateForm()">ìˆ˜ì •</button>
        <div id="myInfoEdit" style="display:none;">
            <p>ë¹„ë°€ë²ˆí˜¸: <input type="password" id="pw" required></p>
            <p>ë‹‰ë„¤ì„: <input type="text" id="nick" required></p>
            <p>ì´ë©”ì¼: <input type="text" id="email" required></p>
            <p>íœ´ëŒ€í°ë²ˆí˜¸: <input type="text" id="phone" required></p>
            <label for="carrier">í†µì‹ ì‚¬:</label>
            <select name="carrier" id="carrier" required>
                <option value="SKT">SKT</option>
                <option value="KT">KT</option>
                <option value="LG U+">LG U+</option>
                <option value="ì•Œëœ°í°">ì•Œëœ°í°</option>
            </select>
            <br><br>
            <button onclick="updateMyInfo()">ìˆ˜ì • ì™„ë£Œ</button>
            <button onclick="deleteUser()">íšŒì› íƒˆí‡´</button>
        </div>
    </div>

    <hr>

    <!-- ê°•ì•„ì§€ ì •ë³´ ì˜ì—­ -->
    <div id="petSection">
        <h2>ê°•ì•„ì§€ ì •ë³´</h2>
        <div id="petList">
            <!-- ê°•ì•„ì§€ ëª©ë¡ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
        </div>
        <button onclick="showPetInsertForm()">ê°•ì•„ì§€ ì¶”ê°€</button>
        <div id="petForm" style="display:none;">
            <input type="hidden" id="petNo">
            <input type="hidden" id="id" th:value="${session.users.id}">
            <p>ì´ë¦„ : <input type="text" id="petName"></p>
            <p>ê²¬ì¢… : <input type="text" id="petBreed"></p>
            <p>ë‚˜ì´ : <input type="number" id="petAge" placeholder="ê°œì›”ìˆ˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”"></p>
            <p>í¬ê¸° : <input type="text" id="petSize" placeholder="m(ë¯¸í„°)ë‹¨ìœ„ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”"></p>
            <p>ë¬´ê²Œ : <input type="text" id="petWeight" placeholder="g(ê·¸ë¨)ë‹¨ìœ„ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”"></p>
            <p><input type="date" id="petBirth"></p>
            <button onclick="submitPet()">ì €ì¥</button>
        </div>
    </div>

    <hr>

    <div id="postSection">
        <h2>ë‚´ê°€ ì“´ ê¸€</h2>

        <!-- íƒ­ ë²„íŠ¼ -->
        <div class="tab-buttons">
            <button onclick="showTab('ask')">ì§ˆì˜ì‘ë‹µ</button>
            <button onclick="showTab('diary')">ë‹¤ì´ì–´ë¦¬</button>
            <button onclick="showTab('info')">ì •ë³´ê²Œì‹œíŒ</button>
            <button onclick="showTab('qna')">ìƒë‹´ê²Œì‹œíŒ</button>
        </div>

        <!-- íƒ­ ì½˜í…ì¸  -->
        <div class="tab-content" id="askTab" style="display:none;"></div>
        <div class="tab-content" id="diaryTab" style="display:none;"></div>
        <div class="tab-content" id="infoTab" style="display:none;"></div>
        <div class="tab-content" id="qnaTab" style="display:none;"></div>
    </div>

<script>
    $(document).ready(function() {
        loadMyInfo();
        loadPets();
    });

    function loadMyInfo() {
        $.post('/myPage/getUser', function(data) {
            $('#myInfoView').html(`
                <span>ë‹‰ë„¤ì„: ${data.nick}  </span>
                <span>ì´ë©”ì¼: ${data.email}</span>
            `);
        });
    }

    function showUpdateForm() {
        $('#myInfoEdit').show();
        $(event.target).hide();
    }

    function updateMyInfo() {
        const user = {
            pw: $('#pw').val(),
            nick: $('#nick').val(),
            email: $('#email').val(),
            phone: $('#phone').val(),
            carrier: $('#carrier').val()
        };        
        $.ajax({
            url: '/myPage/updateUser',
            method: 'POST',
            contentType: 'application/json',       // ğŸ”¸ ë°˜ë“œì‹œ ëª…ì‹œ
            data: JSON.stringify(user),            // ğŸ”¸ ë¬¸ìì—´ë¡œ ì§ë ¬í™”
            
            success: function(res) {
                alert('ìˆ˜ì • ì™„ë£Œ');
                loadMyInfo();
                $('#myInfoEdit').hide();
            }
        });
    }

    function deleteUser() {
        if (!confirm('ì •ë§ íƒˆí‡´í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        $.post('/myPage/deleteUser', function(res) {
            alert('íƒˆí‡´ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤');
            location.href = '/';
        });
    }

    function loadPets() {
        
        $.post('/myPage/getUser', function(user) {
            const id = user.id;
            $.post('/myPage/listPet', { id: id }, function(list) {
                let html = '';
                if (Array.isArray(list)) {
                    list.forEach(pet => {
                        let ageText = '';
                        const age = parseInt(pet.petAge, 10);
                        if (age < 24) {
                            ageText = `${age}ê°œì›”`;
                        } else {
                            const years = Math.floor(age / 12);
                            ageText = `${years}ì‚´`;
                        }
                        html += `
                            <div class="pet-card">
                                <span>ì´ë¦„: ${pet.petName}  </span>
                                <span>ê²¬ì¢…: ${pet.petBreed}  </span>
                                <span>ë‚˜ì´: ${ageText}</span>
                                <button onclick="editPet(${pet.petNo})">ìˆ˜ì •</button>
                                <button onclick="deletePet(${pet.petNo})">ì‚­ì œ</button>
                            </div>
                        `;
                    });
                    $('#petList').html(html);
                } else {
                    console.error("loadPets(): ë°›ì€ ë°ì´í„°ê°€ ë°°ì—´ì´ ì•„ë‹˜", list);
                }
            });
        });
    }

    function showPetInsertForm() {
        $('#petForm').show();
        $('#petForm input').val('');
        $('#petNo').val('');
    }

    function editPet(petNo) {
         console.log("editPet í˜¸ì¶œë¨: petNo =", petNo);
        $.post('/myPage/getPet', { petNo: petNo }, function(pet) {
            $('#petForm').show();
            $('#petNo').val(pet.petNo);
            $('#petName').val(pet.petName);
            $('#petBreed').val(pet.petBreed);
            $('#petAge').val(pet.petAge);
            $('#petSize').val(pet.petSize);
            $('#petWeight').val(pet.petWeight);
            $('#petBirth').val(pet.petBirth);
        });
    }

    function submitPet() {
        const pet = {
            petNo: $('#petNo').val(),
            id: $('#id').val(),
            petName: $('#petName').val(),
            petBreed: $('#petBreed').val(),
            petAge: $('#petAge').val(),
            petSize: $('#petSize').val(),
            petWeight: $('#petWeight').val(),
            petBirth: $('#petBirth').val()
        };
        const url = pet.petNo ? '/myPage/updatePet' : '/myPage/insertPet';
        $.ajax({
            url: url,
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(pet),
            success: function() {
                alert('ì²˜ë¦¬ ì™„ë£Œ');
                loadPets();
                $('#petForm input').val('');
                $('#petForm').hide();
            }
        });
    }

    function deletePet(petNo) {
        $.post('/myPage/deletePet', { petNo }, function() {
            alert('ì‚­ì œ ì™„ë£Œ');
            loadPets();
        });
    }

    function showTab(tabName) {
        $('.tab-content').hide(); // ëª¨ë“  íƒ­ ìˆ¨ê¹€
        $(`#${tabName}Tab`).show(); // í•´ë‹¹ íƒ­ë§Œ í‘œì‹œ

        // í•´ë‹¹ íƒ­ì— ë°ì´í„° ë¡œë“œ
        const loadFunc = {
            ask: loadAskPosts,
            diary: loadDiaryPosts,
            info: loadInfoPosts,
            qna: loadQnaPosts
        };
         if (loadFunc[tabName]) {
            loadFunc ; // 1í˜ì´ì§€ ë¡œë”©
        }
    }

    // ê³µí†µ ë Œë”ë§ í•¨ìˆ˜
    function renderPostList(list, total, page, tabId, loadFuncName) {
    let html = '<ul>';

    // ê²Œì‹œíŒë³„ URL prefix ì§€ì •
    const urlPrefix = {
        askTab: '/board/ask/view',
        diaryTab: '/board/diary/view',
        infoTab: '/board/info/view',
        qnaTab: '/board/qna/view'
    };

    list.forEach(post => {
        html += `<li><a href="${urlPrefix[tabId]}?no=${post.no}">${post.title}</a> (${post.regDate})</li>`;
    });
        html += '</ul>';

        // í˜ì´ì§• ì²˜ë¦¬
        const totalPage = Math.ceil(total / 10);
        html += '<div class="pagination">';
        for (let i = 1; i <= totalPage; i++) {
            html += `<button onclick="${loadFuncName}(${i})" ${i === page ? 'disabled' : ''}>${i}</button>`;
        }
        html += '</div>';

        $(`#${tabId}`).html(html);
    }

    // íƒ­ë³„ Ajax í˜¸ì¶œ
    function loadAskPosts(page) {
        $.get('/myPage/listAsk', { page }, function(res) {
            renderPostList(res.list, res.total, page, 'askTab', 'loadAskPosts');
        });
    }
    function loadDiaryPosts(page) {
        $.get('/myPage/listDiary', { page }, function(res) {
            renderPostList(res.list, res.total, page, 'diaryTab', 'loadDiaryPosts');
        });
    }
    function loadInfoPosts(page) {
        $.get('/myPage/listInfo', { page }, function(res) {
            renderPostList(res.list, res.total, page, 'infoTab', 'loadInfoPosts');
        });
    }
    function loadQnaPosts(page) {
        $.get('/myPage/listQna', { page }, function(res) {
            renderPostList(res.list, res.total, page, 'qnaTab', 'loadQnaPosts');
        });
    }
</script>
</body>
</html>
