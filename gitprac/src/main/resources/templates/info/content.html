<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="/css/infoContent.css">
    <link rel="stylesheet" href="/css/header.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR&display=swap" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script> <!-- jQuery ì¶”ê°€ -->
</head>
<body>
    <div th:replace="~{fragments/header.html :: headerFragment}"></div>

    <!-- ê²Œì‹œê¸€ ë‚´ìš© -->
    <div class="content-top">
        <div class="content-top-title">
            <center>ê¸€ ë‚´ìš©</center>
            <hr width="600" align="center" color="orange">
        </div>
        <div class="content-top-btns">
            <div width="600" align="right">
                <span th:if="${ session.users.nick == idto.writer }">
                    <input type="button" value="ìˆ˜ì •" th:onclick="|window.location='@{/info/update(postNo=${idto.postNo}, pageNum=${pageNum}, category=${category})}'|"/>
                </span>
                <span th:if="${session.users.nick == idto.writer || session.users.role == 2}">
                    <input type="button" value="ì‚­ì œ" th:onclick="|window.location='@{/info/delete(postNo=${idto.postNo}, pageNum=${pageNum}, category=${category})}'|"/>
                </span>
                <input type="button" value="ê¸€ëª©ë¡" th:onclick="|window.location='@{/info/list(pageNum=${pageNum}, category=${idto.category})}'|"/>
            </div>
        </div>
    </div>

    <div class="content-body">
        <div class="content-category-wrapper">
            <h3>ì¹´í…Œê³ ë¦¬ : <span th:text="${idto.category}"></span></h3>
        </div>
        <div class="content-title-wrapper">
            <h3>ê¸€ ì œëª© : <span th:text="${idto.title}"></span></h3>
        </div>
        <div class="content-info-wrapper">
            <div class="content-writer-wrapper">
                ì‘ì„±ì : <span th:text="${idto.writer}"></span>
                <span th:if="${session.users.role == 2}" class="copy-icon" th:attr="data-writer=${idto.writer}">
                ğŸ“‹
                </span>
            </div>
            <div class="content-views-wrapper">
                ì¡°íšŒìˆ˜ | <span th:text="${idto.views}"></span>
            </div>
            <div class="content-reg-wrapper">
                ì‘ì„±ì¼ì | <span th:text="${#temporals.format(idto.reg, 'yy/MM/dd HH:mm')}"></span>
            </div>
        </div>
        <div class="content-content-wrapper">
            <div th:utext="${idto.content}"></div>
        </div>
    </div>

    <!-- ëŒ“ê¸€ ì˜ì—­ -->
    <div class="reply-wrapper" style="width: 600px; margin: 30px auto;">
        <h3>ëŒ“ê¸€</h3>
        <div>
            <textarea id="replyContent" style="width: 100%; height: 60px;" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”."></textarea>
            <button type="button" onclick="addReply(0)">ëŒ“ê¸€ ë“±ë¡</button>
        </div>
        <div id="replyList" style="margin-top: 20px;"></div>
    </div>

    <script th:inline="javascript">
    const postNo = /*[[${idto.postNo}]]*/ 0;
    const currentUser = /*[[${session.users.nick}]]*/ 'anonymous';
    const currentUserRole = /*[[${session.users.role}]]*/ 0;

    function addReply(refNo) {
        const textareaId = refNo === 0 ? "replyContent" : `reContent-${refNo}`;
        const content = document.getElementById(textareaId).value;

        if (!content.trim()) {
            alert("ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return;
        }

        $.ajax({
            url: "/info/reply/add",
            method: "POST",
            contentType: "application/json",
            data: JSON.stringify({
                postNo: postNo,
                content: content,
                ref: refNo
            }),
            success: function (res) {
                if (res === "unauthorized") {
                    alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
                } else {
                    loadReply();
                    if (refNo !== 0) {
                        document.getElementById(`reBox-${refNo}`).style.display = "none";
                    }
                    document.getElementById(textareaId).value = "";
                }
            }
        });
    }

    function showReplyBox(replyNo) {
        document.getElementById(`reBox-${replyNo}`).style.display = "block";
    }

    function deleteReply(replyNo) {
        if (!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

        $.ajax({
            url: "/info/reply/delete?replyNo=" + replyNo,
            method: "DELETE",
            success: function () {
                loadReply();
            }
        });
    }


    function showEditBox(replyNo, content) {
        const replyDiv = document.getElementById(`replyDiv-${replyNo}`);
        replyDiv.innerHTML = `
            <textarea id="editContent-${replyNo}" style="width: 100%; height: 50px;">${content}</textarea>
            <button onclick="editReply(${replyNo})">ì €ì¥</button>
            <button onclick="loadReply()">ì·¨ì†Œ</button>
        `;
    }

    function editReply(replyNo) {
        const content = document.getElementById(`editContent-${replyNo}`).value;

        $.ajax({
            url: "/info/reply/update",
            method: "PUT",
            contentType: "application/json",
            data: JSON.stringify({ replyNo: replyNo, content: content }),
            success: function () {
                loadReply();
            }
        });
    }

    function loadReply() {
        $.ajax({
            url: "/info/reply/list?postNo=" + postNo,
            method: "GET",
            success: function (data) {
                let html = "";
                data.forEach(reply => {
                    const isReply = reply.ref !== 0;
                    const isWriter = currentUser === reply.writer;

                    html += `
                        <div style="margin-left:${isReply ? '30px' : '0'}; padding: 5px; border-bottom: 1px solid #ccc;">
                            <div id="replyDiv-${reply.replyNo}">
                                <b>${reply.writer}</b>`;
                    if( currentUserRole === 2 ){
                        html += `<span class="copy-icon" data-writer="${reply.writer}">ğŸ“‹</span>`;
                    }
                    html += ` : `;
                    
                    if( reply.status === 0 ){
                        html += `${reply.content}`;
                    } else {
                        html += `<span style="color:gray;">ê´€ë¦¬ìì— ì˜í•´ ì œì¬ëœ ì‚¬ìš©ìì˜ ê¸€ì…ë‹ˆë‹¤.</span>`;
                    }
                    
                    html += `
                                <span style="font-size: 0.9em; color: gray;">(${reply.reg})</span>
                                ${isWriter ? `
                                    <button onclick="showEditBox(${reply.replyNo}, '${reply.content}')">ìˆ˜ì •</button>` : ""}
                                ${isWriter || currentUserRole === 2 ? `
                                    <button onclick="deleteReply(${reply.replyNo})">ì‚­ì œ</button>` : ""}
                                <button onclick="showReplyBox(${reply.replyNo})">ë‹µê¸€</button>
                            </div>
                            <div id="reBox-${reply.replyNo}" style="display:none; margin-top:5px;">
                                <textarea id="reContent-${reply.replyNo}" style="width: 100%; height: 50px;" placeholder="ëŒ€ëŒ“ê¸€ ì…ë ¥"></textarea>
                                <button type="button" onclick="addReply(${reply.replyNo})">ë“±ë¡</button>
                            </div>
                        </div>
                    `;
                });
                document.getElementById("replyList").innerHTML = html;
            }
        });
    }

    $(document).ready(function () {
        loadReply();
    });

    // ì‘ì„±ìëª…ì„ í´ë¦­í•˜ì—¬ ë³µì‚¬í•˜ëŠ” API ì‚¬ìš©
    $(document).ready(function(){
        $(document).on('click', '.copy-icon', function(e){
            let writer = $(this).data('writer');
    
            navigator.clipboard.writeText(writer).then(function(){
                alert(`"${writer}" ë³µì‚¬ë¨`);
            }).catch(function(err){
                console.log("ë³µì‚¬ ì‹¤íŒ¨ : ", err);
            });
        });
    });
</script>
